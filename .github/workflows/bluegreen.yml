name: CI-CD Blue-Green Deploy

on:
  push:
    branches:
      - main

env:
  IMAGE: ghcr.io/jbrayner123/practica-ing-software/app:${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.IMAGE }} -f backend/Dockerfile backend
          docker push ${{ env.IMAGE }}

  deploy-green:
    name: Deploy to Green Namespace
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Create green namespace if not exists
        run: |
          kubectl create namespace green --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy Database dependencies first
        run: |
          # Aplica primero la base de datos y servicios esenciales
          kubectl apply -n green -f infrastructure/k8s/postgres-deployment.yaml || echo "PostgreSQL no encontrado"
          kubectl apply -n green -f infrastructure/k8s/backend-service.yaml || echo "Service no encontrado"
          sleep 10

      - name: Deploy GREEN with proper configuration
        run: |
          cat > deployment-green.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: practica-backend-green
            namespace: green
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: practica-backend
                version: green
            strategy:
              type: RollingUpdate
              rollingUpdate:
                maxUnavailable: 0
                maxSurge: 1
            template:
              metadata:
                labels:
                  app: practica-backend
                  version: green
              spec:
                containers:
                - name: backend
                  image: ${{ env.IMAGE }}
                  ports:
                  - containerPort: 5000
                  env:
                  - name: FLASK_ENV
                    value: "production"
                  - name: DATABASE_URL
                    value: "postgresql://user:password@postgres-service.green.svc.cluster.local:5432/dbname"
                  readinessProbe:
                    httpGet:
                      path: /
                      port: 5000
                    initialDelaySeconds: 25
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
                  livenessProbe:
                    httpGet:
                      path: /
                      port: 5000
                    initialDelaySeconds: 40
                    periodSeconds: 15
                    timeoutSeconds: 5
                    failureThreshold: 3
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "250m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
          EOF
          
          sed -i "s|\${{ env.IMAGE }}|${{ env.IMAGE }}|g" deployment-green.yaml
          kubectl apply -f deployment-green.yaml

      - name: Wait for rollout with progressive checks
        run: |
          echo "‚è≥ Esperando despliegue GREEN..."
          sleep 30
          
          for i in {1..12}; do
            echo "Check #$i - Estado de los pods:"
            kubectl get pods -n green -l version=green
            
            if kubectl get pods -n green -l version=green | grep -q "Running"; then
              echo "‚úÖ Al menos un pod est√° Running, verificando logs..."
              POD_NAME=$(kubectl get pods -n green -l version=green --field-selector=status.phase=Running -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
              
              if [ -n "$POD_NAME" ]; then
                echo "=== Logs del pod $POD_NAME ==="
                kubectl logs -n green $POD_NAME --tail=20
              fi
            fi
            
            if kubectl rollout status deployment/practica-backend-green -n green --timeout=10s 2>/dev/null; then
              echo "‚úÖüéâ Deployment GREEN completado exitosamente!"
              exit 0
            fi
            
            echo "‚åõ Intento $i/12 - Deployment a√∫n no est√° listo, esperando 15 segundos..."
            sleep 15
          done
          
          echo "‚ùå TIMEOUT - Despliegue fall√≥ despu√©s de 3 minutos"
          echo "=== DEBUG DETALLADO ==="
          kubectl get all -n green
          echo "=== DESCRIBE DEPLOYMENT ==="
          kubectl describe deployment practica-backend-green -n green
          echo "=== EVENTOS ==="
          kubectl get events -n green --sort-by='.lastTimestamp'
          echo "=== LOGS DE TODOS LOS PODS ==="
          for pod in $(kubectl get pods -n green -l version=green -o name); do
            echo "Logs para $pod:"
            kubectl logs -n green $pod --tail=50 || echo "No se pueden obtener logs"
          done
          exit 1

      - name: Deploy Frontend to Green
        if: success()
        run: |
          kubectl apply -n green -f infrastructure/k8s/frontend-deployment.yaml || echo "Frontend no configurado"
          kubectl apply -n green -f infrastructure/k8s/frontend-service.yaml || echo "Frontend service no configurado"

  switch-traffic:
    name: Switch Traffic to Green
    needs: deploy-green
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Switch traffic to Green
        run: |
          echo "üîÑ Cambiando tr√°fico a GREEN..."
          # Actualiza el selector del servicio para apuntar a green
          kubectl patch service practica-backend-service -n green -p '{"spec":{"selector":{"version":"green"}}}' || echo "Service patch no aplicado"
          echo "‚úÖ Tr√°fico dirigido a GREEN"

      - name: Scale down old deployment (optional)
        run: |
          echo "üìâ Escalando deployment anterior a 0 r√©plicas..."
          # Escala cualquier deployment anterior (blue) a 0
          kubectl scale deployment -n green --replicas=0 -l app=practica-backend,version!=green --timeout=30s || echo "No hay deployments anteriores para escalar"
