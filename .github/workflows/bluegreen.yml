name: CI-CD Blue-Green Deploy

on:
  push:
    branches:
      - main

env:
  IMAGE: ghcr.io/jbrayner123/practica-ing-software/app:${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.IMAGE }} -f backend/Dockerfile backend
          docker push ${{ env.IMAGE }}

  cleanup-green:
    name: Cleanup Green Namespace
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Clean failed deployments
        run: |
          kubectl delete deployment practica-backend-green -n green --ignore-not-found=true
          kubectl delete pod -n green -l app=practica-backend --ignore-not-found=true
          echo "‚úÖ Namespace green limpiado"

  deploy-green:
    name: Deploy to Green Namespace
    needs: [build, cleanup-green]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Create image pull secret for GHCR
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            -n green --dry-run=client -o yaml | kubectl apply -f -

      - name: Test Database Connection with New Credentials
        run: |
          echo "üîç Probando conexi√≥n con las NUEVAS credenciales..."
          kubectl run -n green db-test --rm -i --restart=Never --image=postgres:13 -- \
            sh -c '
            apt-get update && apt-get install -y postgresql-client && \
            PGPASSWORD="na3TJH8rJ2Ra0pFT1i1fekZqeZv24eJm" psql \
            -h dpg-d4f2r0lrnu6s73dpudh0-a.oregon-postgres.render.com \
            -U pollito \
            -d mydb_gfpg \
            -c "SELECT 1 as connection_test;" \
            --set=sslmode=require
            ' && echo "‚úÖ‚úÖ‚úÖ CONEXI√ìN EXITOSA - Las credenciales son correctas" || echo "‚ùå La conexi√≥n fall√≥"

      - name: Deploy GREEN with Corrected Render Database
        run: |
          cat > deployment-green.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: practica-backend-green
            namespace: green
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: practica-backend
                version: green
            template:
              metadata:
                labels:
                  app: practica-backend
                  version: green
              spec:
                imagePullSecrets:
                - name: ghcr-secret
                containers:
                - name: practica-backend
                  image: ${{ env.IMAGE }}
                  ports:
                  - containerPort: 3000
                  env:
                  - name: DATABASE_URL
                    value: "postgresql://pollito:na3TJH8rJ2Ra0pFT1i1fekZqeZv24eJm@dpg-d4f2r0lrnu6s73dpudh0-a.oregon-postgres.render.com/mydb_gfpg?ssl=true"
                  - name: PORT
                    value: "3000"
                  resources:
                    requests:
                      memory: "128Mi"
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          EOF
          
          sed -i "s|\${{ env.IMAGE }}|${{ env.IMAGE }}|g" deployment-green.yaml
          kubectl apply -f deployment-green.yaml

      - name: Wait for deployment with debug
        run: |
          echo "‚è≥ Esperando despliegue GREEN..."
          sleep 30
          
          for i in {1..20}; do
            echo "Check #$i - Estado del pod:"
            kubectl get pods -n green -l version=green
            
            POD_NAME=$(kubectl get pods -n green -l version=green -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            
            if [ -n "$POD_NAME" ]; then
              POD_STATUS=$(kubectl get pod -n green $POD_NAME -o jsonpath='{.status.phase}')
              echo "Status del pod: $POD_STATUS"
              
              if [ "$POD_STATUS" = "Running" ]; then
                echo "‚úÖ Pod est√° RUNNING!"
                echo "=== Logs del pod ==="
                kubectl logs -n green $POD_NAME --tail=25
                echo "=== Verificando conexi√≥n a BD en los logs ==="
                kubectl logs -n green $POD_NAME | grep -i "database\|postgres\|connection\|error\|success\|connected" || echo "No se encontraron mensajes de BD espec√≠ficos"
                echo "‚úÖ Deployment completado exitosamente!"
                exit 0
              elif [ "$POD_STATUS" = "Pending" ]; then
                echo "‚ùå Pod a√∫n PENDING - mostrando detalles:"
                kubectl describe pod -n green $POD_NAME
              elif [ "$POD_STATUS" = "ErrImagePull" ] || [ "$POD_STATUS" = "ImagePullBackOff" ]; then
                echo "‚ùå‚ùå‚ùå ERROR DESCARGANDO IMAGEN ‚ùå‚ùå‚ùå"
                kubectl describe pod -n green $POD_NAME
                exit 1
              fi
            fi
            
            echo "‚åõ Esperando 10 segundos..."
            sleep 10
          done
          
          echo "‚ùå TIMEOUT - Pod nunca lleg√≥ a Running"
          kubectl get events -n green --sort-by='.lastTimestamp' | tail -20
          exit 1

  switch-traffic:
    name: Switch Traffic to Green
    needs: deploy-green
    runs-on: ubuntu-latest
    if: ${{ success() }}
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Switch traffic to Green
        run: |
          echo "üîÑ Cambiando tr√°fico a GREEN..."
          kubectl patch service practica-backend-service -n green -p '{"spec":{"selector":{"version":"green"}}}' || echo "Service patch no aplicado"
          echo "‚úÖ Tr√°fico dirigido a GREEN"

      - name: Scale down old deployment
        run: |
          echo "üìâ Escalando deployment anterior a 0 r√©plicas..."
          kubectl scale deployment -n green --replicas=0 -l app=practica-backend,version!=green --timeout=30s || echo "No hay deployments anteriores para escalar"
