name: CI-CD Blue-Green Deploy

on:
  push:
    branches:
      - main

env:
  IMAGE: ghcr.io/jbrayner123/practica-ing-software/app:${{ github.sha }}

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ env.IMAGE }} -f backend/Dockerfile backend
          docker push ${{ env.IMAGE }}

  cleanup-green:
    name: Cleanup Green Namespace
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Clean failed deployments
        run: |
          kubectl delete deployment practica-backend-green -n green --ignore-not-found=true
          kubectl delete pod -n green -l app=practica-backend --ignore-not-found=true
          echo "✅ Namespace green limpiado"

  deploy-green:
    name: Deploy to Green Namespace
    needs: [build, cleanup-green]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name ${{ secrets.EKS_CLUSTER_NAME }}

      - name: Create image pull secret for GHCR
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            -n green --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy GREEN with minimal resources
        run: |
          cat > deployment-green.yaml << 'EOF'
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: practica-backend-green
            namespace: green
          spec:
            replicas: 1  # SOLO 1 RÉPLICA PARA PRUEBAS
            selector:
              matchLabels:
                app: practica-backend
                version: green
            template:
              metadata:
                labels:
                  app: practica-backend
                  version: green
              spec:
                imagePullSecrets:
                - name: ghcr-secret
                containers:
                - name: practica-backend
                  image: ${{ env.IMAGE }}
                  ports:
                  - containerPort: 3001  # PUERTO CORRECTO SEGÚN TU DEPLOYMENT
                  # PROBES TEMPORALMENTE DESHABILITADOS PARA DEBUG
                  # readinessProbe:
                  #   httpGet:
                  #     path: /readiness
                  #     port: 3001
                  #   initialDelaySeconds: 30
                  #   periodSeconds: 10
                  # livenessProbe:
                  #   httpGet:
                  #     path: /healthz
                  #     port: 3001
                  #   initialDelaySeconds: 45
                  #   periodSeconds: 15
                  resources:
                    requests:
                      memory: "128Mi"  # MÍNIMOS RECURSOS
                      cpu: "100m"
                    limits:
                      memory: "256Mi"
                      cpu: "200m"
          EOF
          
          sed -i "s|\${{ env.IMAGE }}|${{ env.IMAGE }}|g" deployment-green.yaml
          kubectl apply -f deployment-green.yaml

      - name: Wait for deployment with debug
        run: |
          echo "⏳ Esperando despliegue GREEN (con probes deshabilitados)..."
          sleep 30
          
          # Verificación manual sin health checks
          for i in {1..20}; do
            echo "Check #$i - Estado del pod:"
            kubectl get pods -n green -l version=green
            
            POD_NAME=$(kubectl get pods -n green -l version=green -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            
            if [ -n "$POD_NAME" ]; then
              POD_STATUS=$(kubectl get pod -n green $POD_NAME -o jsonpath='{.status.phase}')
              echo "Status del pod: $POD_STATUS"
              
              if [ "$POD_STATUS" = "Running" ]; then
                echo "✅ Pod está RUNNING!"
                echo "=== Logs del pod ==="
                kubectl logs -n green $POD_NAME --tail=20
                echo "✅ Deployment completado exitosamente!"
                exit 0
              elif [ "$POD_STATUS" = "Pending" ]; then
                echo "❌ Pod aún PENDING - mostrando detalles:"
                kubectl describe pod -n green $POD_NAME
              fi
            fi
            
            echo "⌛ Esperando 10 segundos..."
            sleep 10
          done
          
          echo "❌ TIMEOUT - Pod nunca llegó a Running"
          kubectl get events -n green --sort-by='.lastTimestamp' | tail -20
          exit 1
